# name: test/sql/lineage_v2/l_mergejoin/test_mergejoin.test
# description: Test Piecewise Merge Joins
# group: [l_mergejoin]


statement ok
CREATE TABLE t1(i INTEGER, j INTEGER);

statement ok
INSERT INTO t1 VALUES (3, 1),  (NULL, 2), (2, 3), (3, 4), (3, 8), (3, 7)

statement ok
INSERT INTO t1 SELECT i, i+1 FROM range(0,10) tbl(i);

statement ok
CREATE TABLE t2(i INTEGER, k VARCHAR(10));

statement ok
INSERT INTO t2 SELECT i, 'C' FROM range(0,10) tbl(i);

statement ok
INSERT INTO t2 VALUES (3, 'A'),   (NULL, 'B'), (3, 'C'), (1, 'D'), (100, 'A')


statement ok
PRAGMA enable_profiling;

statement ok
PRAGMA enable_lineage

# q1: inner
query II
select t1.rowid, t2.rowid from t1 inner join t2 on (t1.i > t2.i)
----
15	8
15	7
14	7
15	6
14	6
13	6
15	5
14	5
13	5
12	5
15	4
14	4
13	4
12	4
11	4
15	3
14	3
13	3
12	3
11	3
10	3
15	10
14	10
13	10
12	10
11	10
10	10
15	12
14	12
13	12
12	12
11	12
10	12
15	2
14	2
13	2
12	2
11	2
10	2
0	2
3	2
4	2
5	2
9	2
15	1
14	1
13	1
12	1
11	1
10	1
0	1
3	1
4	1
5	1
9	1
2	1
8	1
15	13
14	13
13	13
12	13
11	13
10	13
0	13
3	13
4	13
5	13
9	13
2	13
8	13
15	0
14	0
13	0
12	0
11	0
10	0
0	0
3	0
4	0
5	0
9	0
2	0
8	0
7	0


# q2: right
query II
select t1.rowid, t2.rowid from t1 right join t2 on (t1.i > t2.i)
----
7	0
2	0
2	1
2	13
8	0
8	1
8	13
0	0
0	1
0	13
0	2
3	0
3	1
3	13
3	2
4	0
4	1
4	13
4	2
5	0
5	1
5	13
5	2
9	0
9	1
9	13
9	2
10	0
10	1
10	13
10	2
10	3
10	10
10	12
11	0
11	1
11	13
11	2
11	3
11	10
11	12
11	4
12	0
12	1
12	13
12	2
12	3
12	10
12	12
12	4
12	5
13	0
13	1
13	13
13	2
13	3
13	10
13	12
13	4
13	5
13	6
14	0
14	1
14	13
14	2
14	3
14	10
14	12
14	4
14	5
14	6
14	7
15	0
15	1
15	13
15	2
15	3
15	10
15	12
15	4
15	5
15	6
15	7
15	8
NULL	9
NULL	14
NULL	11


# q3: left
query II
select t1.rowid, t2.rowid from t1 left join t2 on (t1.i > t2.i)
----
15	8
15	7
14	7
15	6
14	6
13	6
15	5
14	5
13	5
12	5
15	4
14	4
13	4
12	4
11	4
15	3
14	3
13	3
12	3
11	3
10	3
15	10
14	10
13	10
12	10
11	10
10	10
15	12
14	12
13	12
12	12
11	12
10	12
15	2
14	2
13	2
12	2
11	2
10	2
0	2
3	2
4	2
5	2
9	2
15	1
14	1
13	1
12	1
11	1
10	1
0	1
3	1
4	1
5	1
9	1
2	1
8	1
15	13
14	13
13	13
12	13
11	13
10	13
0	13
3	13
4	13
5	13
9	13
2	13
8	13
15	0
14	0
13	0
12	0
11	0
10	0
0	0
3	0
4	0
5	0
9	0
2	0
8	0
7	0
6	NULL
1	NULL


# q4: full outer
query II
select t1.rowid, t2.rowid from t1 full outer join t2 on (t1.i > t2.i)
----
15	8
15	7
14	7
15	6
14	6
13	6
15	5
14	5
13	5
12	5
15	4
14	4
13	4
12	4
11	4
15	3
14	3
13	3
12	3
11	3
10	3
15	10
14	10
13	10
12	10
11	10
10	10
15	12
14	12
13	12
12	12
11	12
10	12
15	2
14	2
13	2
12	2
11	2
10	2
0	2
3	2
4	2
5	2
9	2
15	1
14	1
13	1
12	1
11	1
10	1
0	1
3	1
4	1
5	1
9	1
2	1
8	1
15	13
14	13
13	13
12	13
11	13
10	13
0	13
3	13
4	13
5	13
9	13
2	13
8	13
15	0
14	0
13	0
12	0
11	0
10	0
0	0
3	0
4	0
5	0
9	0
2	0
8	0
7	0
6	NULL
1	NULL
NULL	14
NULL	9
NULL	11


# q5: semi
query I
select t1.rowid from t1 semi join t2 on (t1.i > t2.i)
----
15
14
13
12
11
10
0
3
4
5
9
2
8
7

# q6: semi
query I
select t2.rowid from t2 semi join t1 on (t1.i > t2.i)
----
0
1
13
2
3
10
12
4
5
6
7
8

# q7: anti
query III
select t1.rowid, t1.i, t1.j from t1 anti join t2 on (t1.i > t2.i)
----
6	0	1
1	NULL	2

# q8: anti
query III
select t2.rowid, t2.i, t2.k from t2 anti join t1 on (t1.i > t2.i)
----
9	9	C
14	100	A
11	NULL	B

statement ok
PRAGMA disable_lineage;
PRAGMA disable_profiling;
PRAGMA disable_optimizer;


query III
pragma  Provenance("lineage", "select t1.rowid, t2.rowid from t1 inner join t2 on (t1.i > t2.i)");
----
15	8	0
15	7	1
14	7	2
15	6	3
14	6	4
13	6	5
15	5	6
14	5	7
13	5	8
12	5	9
15	4	10
14	4	11
13	4	12
12	4	13
11	4	14
15	3	15
14	3	16
13	3	17
12	3	18
11	3	19
10	3	20
15	10	21
14	10	22
13	10	23
12	10	24
11	10	25
10	10	26
15	12	27
14	12	28
13	12	29
12	12	30
11	12	31
10	12	32
15	2	33
14	2	34
13	2	35
12	2	36
11	2	37
10	2	38
0	2	39
3	2	40
4	2	41
5	2	42
9	2	43
15	1	44
14	1	45
13	1	46
12	1	47
11	1	48
10	1	49
0	1	50
3	1	51
4	1	52
5	1	53
9	1	54
2	1	55
8	1	56
15	13	57
14	13	58
13	13	59
12	13	60
11	13	61
10	13	62
0	13	63
3	13	64
4	13	65
5	13	66
9	13	67
2	13	68
8	13	69
15	0	70
14	0	71
13	0	72
12	0	73
11	0	74
10	0	75
0	0	76
3	0	77
4	0	78
5	0	79
9	0	80
2	0	81
8	0	82
7	0	83

query III
pragma  Provenance("lineage", "select t1.rowid, t2.rowid from t1 right join t2 on (t1.i > t2.i)");
----
0	7	0
0	2	1
1	2	2
13	2	3
0	8	4
1	8	5
13	8	6
0	0	7
1	0	8
13	0	9
2	0	10
0	3	11
1	3	12
13	3	13
2	3	14
0	4	15
1	4	16
13	4	17
2	4	18
0	5	19
1	5	20
13	5	21
2	5	22
0	9	23
1	9	24
13	9	25
2	9	26
0	10	27
1	10	28
13	10	29
2	10	30
3	10	31
10	10	32
12	10	33
0	11	34
1	11	35
13	11	36
2	11	37
3	11	38
10	11	39
12	11	40
4	11	41
0	12	42
1	12	43
13	12	44
2	12	45
3	12	46
10	12	47
12	12	48
4	12	49
5	12	50
0	13	51
1	13	52
13	13	53
2	13	54
3	13	55
10	13	56
12	13	57
4	13	58
5	13	59
6	13	60
0	14	61
1	14	62
13	14	63
2	14	64
3	14	65
10	14	66
12	14	67
4	14	68
5	14	69
6	14	70
7	14	71
0	15	72
1	15	73
13	15	74
2	15	75
3	15	76
10	15	77
12	15	78
4	15	79
5	15	80
6	15	81
7	15	82
8	15	83
9	NULL	84
14	NULL	85
11	NULL	86


query III
pragma  Provenance("lineage", "select t1.rowid, t2.rowid from t1 left join t2 on (t1.i > t2.i)");
----
15	8	0
15	7	1
14	7	2
15	6	3
14	6	4
13	6	5
15	5	6
14	5	7
13	5	8
12	5	9
15	4	10
14	4	11
13	4	12
12	4	13
11	4	14
15	3	15
14	3	16
13	3	17
12	3	18
11	3	19
10	3	20
15	10	21
14	10	22
13	10	23
12	10	24
11	10	25
10	10	26
15	12	27
14	12	28
13	12	29
12	12	30
11	12	31
10	12	32
15	2	33
14	2	34
13	2	35
12	2	36
11	2	37
10	2	38
0	2	39
3	2	40
4	2	41
5	2	42
9	2	43
15	1	44
14	1	45
13	1	46
12	1	47
11	1	48
10	1	49
0	1	50
3	1	51
4	1	52
5	1	53
9	1	54
2	1	55
8	1	56
15	13	57
14	13	58
13	13	59
12	13	60
11	13	61
10	13	62
0	13	63
3	13	64
4	13	65
5	13	66
9	13	67
2	13	68
8	13	69
15	0	70
14	0	71
13	0	72
12	0	73
11	0	74
10	0	75
0	0	76
3	0	77
4	0	78
5	0	79
9	0	80
2	0	81
8	0	82
7	0	83
6	NULL	84
1	NULL	85

query III
pragma  Provenance("lineage", "select t1.rowid, t2.rowid from t1 full outer join t2 on (t1.i > t2.i)");
----
15	8	0
15	7	1
14	7	2
15	6	3
14	6	4
13	6	5
15	5	6
14	5	7
13	5	8
12	5	9
15	4	10
14	4	11
13	4	12
12	4	13
11	4	14
15	3	15
14	3	16
13	3	17
12	3	18
11	3	19
10	3	20
15	10	21
14	10	22
13	10	23
12	10	24
11	10	25
10	10	26
15	12	27
14	12	28
13	12	29
12	12	30
11	12	31
10	12	32
15	2	33
14	2	34
13	2	35
12	2	36
11	2	37
10	2	38
0	2	39
3	2	40
4	2	41
5	2	42
9	2	43
15	1	44
14	1	45
13	1	46
12	1	47
11	1	48
10	1	49
0	1	50
3	1	51
4	1	52
5	1	53
9	1	54
2	1	55
8	1	56
15	13	57
14	13	58
13	13	59
12	13	60
11	13	61
10	13	62
0	13	63
3	13	64
4	13	65
5	13	66
9	13	67
2	13	68
8	13	69
15	0	70
14	0	71
13	0	72
12	0	73
11	0	74
10	0	75
0	0	76
3	0	77
4	0	78
5	0	79
9	0	80
2	0	81
8	0	82
7	0	83
6	NULL	84
1	NULL	85
NULL	14	86
NULL	9	87
NULL	11	88

query III
pragma  Provenance("lineage", "select t1.rowid from t1 semi join t2 on (t1.i > t2.i)");
----
15	NULL	0
14	NULL	1
13	NULL	2
12	NULL	3
11	NULL	4
10	NULL	5
0	NULL	6
3	NULL	7
4	NULL	8
5	NULL	9
9	NULL	10
2	NULL	11
8	NULL	12
7	NULL	13

query III
pragma  Provenance("lineage", "select t2.rowid from t2 semi join t1 on (t1.i > t2.i)");
----
0	NULL	0
1	NULL	1
13	NULL	2
2	NULL	3
3	NULL	4
10	NULL	5
12	NULL	6
4	NULL	7
5	NULL	8
6	NULL	9
7	NULL	10
8	NULL	11


query III
pragma  Provenance("lineage", "select t1.rowid, t1.i, t1.j from t1 anti join t2 on (t1.i > t2.i)")
----
6	NULL	0
1	NULL	1

query III
pragma  Provenance("lineage", "select t2.rowid, t2.i, t2.k from t2 anti join t1 on (t1.i > t2.i)")
----
9	NULL	0
14	NULL	1
11	NULL	2
